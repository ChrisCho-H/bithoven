pragma bithoven version 0.0.1;
pragma bithoven target segwit;

/*
 * Simplified Payment Channel
 * 
 * Enables off-chain micropayments with on-chain settlement.
 * Alice (payer) and Bob (payee) can cooperatively close the channel,
 * or either can unilaterally close after a dispute period.
 * 
 * This showcases:
 * - Layer 2 scaling solution pattern
 * - Cooperative vs unilateral channel closing
 * - Time-delayed settlement for security
 */

// Path 1: Cooperative close (both parties agree - instant)
(sig_alice: signature, sig_bob: signature)

// Path 2: Unilateral close by Alice (requires waiting period)
(state_hash_alice: string, sig_alice_unilateral: signature)

// Path 3: Unilateral close by Bob (requires waiting period)
(state_hash_bob: string, sig_bob_unilateral: signature)

{
    // Check if Alice signed (could be cooperative or unilateral)
    if checksig(sig_alice, "0279be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798") {
        // Alice signed - check if Bob also signed (cooperative close)
        return checksig(sig_bob, "03c9f4836b9a4f77fc0d81f7bcb01b7f1b35916864b9476c241ce9fc198bd25432");
    }
    else {
        // Not cooperative close - check unilateral paths
        // Check if this is Alice's unilateral close
        if len(state_hash_alice) == 32 {
            // Unilateral close by Alice
            older 144;  // 1 day dispute period
            return checksig(sig_alice_unilateral, "0279be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798");
        }
        else {
            // Unilateral close by Bob
            older 144;  // 1 day dispute period
            verify len(state_hash_bob) == 32;
            return checksig(sig_bob_unilateral, "03c9f4836b9a4f77fc0d81f7bcb01b7f1b35916864b9476c241ce9fc198bd25432");
        }
    }
}
